generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

/// Switch to PostgreSQL by replacing the datasource above with the block below.
// datasource db {
//   provider = "postgresql"
//   url      = env("DATABASE_URL")
// }

model User {
  id                  Int                 @id @default(autoincrement()) @map("user_id")
  username            String              @unique
  email               String              @unique
  password            String
  isActive            Boolean             @default(true) @map("is_active")
  isDeleted           Boolean             @default(false) @map("is_deleted")
  passwordChangedAt   DateTime?           @map("password_changed_at")
  passwordExpiry      DateTime?           @map("password_expiry")
  accountLockedUntil  DateTime?           @map("account_locked_until")
  createdAt           DateTime            @default(now()) @map("created_at")
  updatedAt           DateTime            @updatedAt @map("updated_at")
  roleId              Int?                @map("role_id")

  role                Role?               @relation(fields: [roleId], references: [roleId])
  sessions            UserSession[]
  loginAttempts       LoginAttempt[]
  passwordHistory     PasswordHistory[]
  trustedDevices      TrustedDevice[]
  mfaTokens           MFAToken[]
  auditLogs           AuditLog[]
  caretakerCats       Cat[]               @relation("CaretakerCats")
  caretakerAssignments CaretakerAssignment[]

  @@map("Users")
  @@index([username], map: "idx_username")
}

model UserSession {
  id                   Int       @id @default(autoincrement()) @map("session_id")
  userId               Int       @map("user_id")
  token                String    @unique
  ipAddress            String    @map("ip_address")
  deviceFingerprint    String?   @map("device_fingerprint")
  tlsVersion           String?   @map("tls_version")
  cipherSuite          String?   @map("cipher_suite")
  certificateSignature String?   @map("certificate_signature")
  createdAt            DateTime  @default(now()) @map("created_at")
  lastActiveAt         DateTime  @default(now()) @map("last_active_at")
  isActive             Boolean   @default(true) @map("is_active")

  user User @relation(fields: [userId], references: [id])

  @@map("UserSessions")
}

model LoginAttempt {
  id         Int       @id @default(autoincrement()) @map("attempt_id")
  userId     Int?      @map("user_id")
  ipAddress  String    @map("ip_address")
  username   String?
  success    Boolean   @default(false)
  attemptedAt DateTime @default(now()) @map("attempted_at")

  user User? @relation(fields: [userId], references: [id])

  @@map("LoginAttempts")
}

model PasswordHistory {
  id        Int      @id @default(autoincrement()) @map("history_id")
  userId    Int      @map("user_id")
  oldPassword String @map("old_password")
  changedAt DateTime @default(now()) @map("changed_at")

  user User @relation(fields: [userId], references: [id])

  @@map("PasswordHistory")
}

model TrustedDevice {
  id                Int      @id @default(autoincrement()) @map("device_id")
  userId            Int      @map("user_id")
  deviceFingerprint String   @map("device_fingerprint")
  deviceName        String?  @map("device_name")
  isActive          Boolean  @default(true) @map("is_active")
  registeredAt      DateTime @default(now()) @map("registered_at")

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, deviceFingerprint])
  @@map("TrustedDevices")
}

model MFAToken {
  id         Int      @id @default(autoincrement()) @map("token_id")
  userId     Int      @map("user_id")
  tokenType  String   @map("token_type")
  tokenValue String   @map("token_value")
  createdAt  DateTime @default(now()) @map("created_at")
  lastUsedAt DateTime? @map("last_used_at")
  isActive   Boolean  @default(true) @map("is_active")

  user User @relation(fields: [userId], references: [id])

  @@map("MFATokens")
}

model Role {
  roleId      Int     @id @default(autoincrement()) @map("role_id")
  roleName    String  @unique @map("role_name")
  description String?

  users User[]

  @@map("Roles")
}

model AuditLog {
  id          Int      @id @default(autoincrement()) @map("log_id")
  userId      Int?     @map("user_id")
  operation   String   @map("operation")
  tableName   String?  @map("table_name")
  rowId       Int?     @map("row_id")
  eventType   String?  @map("event_type")
  createdAt   DateTime @default(now()) @map("created_at")
  success     Boolean  @default(true)
  errorMessage String? @map("error_message")
  changes     String?
  extra       String?

  user User? @relation(fields: [userId], references: [id])

  @@map("AuditLogs")
}

model Cat {
  id          Int       @id @default(autoincrement()) @map("cat_id")
  name        String
  breed       String?
  birthDate   DateTime? @map("birth_date")
  friends     String?
  caretakerId Int?      @map("caretaker_id")
  updatedAt   DateTime  @default(now()) @map("updated_at")

  caretaker User? @relation("CaretakerCats", fields: [caretakerId], references: [id])
  assignments CaretakerAssignment[]

  @@map("Cats")
}

model CaretakerAssignment {
  id          Int      @id @default(autoincrement()) @map("assignment_id")
  userId      Int      @map("user_id")
  catId       Int      @map("cat_id")
  assignedAt  DateTime @default(now()) @map("assigned_at")
  unassignedAt DateTime? @map("unassigned_at")

  user User @relation(fields: [userId], references: [id])
  cat  Cat  @relation(fields: [catId], references: [id])

  @@unique([userId, catId])
  @@map("CaretakerAssignments")
}

