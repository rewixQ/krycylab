generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_DATABASE_URL")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model auditlogs {
  log_id             BigInt           @id @default(autoincrement())
  user_id            Int?
  session_id         Int?
  operation          String           @db.VarChar(32)
  table_name         audit_table_enum
  record_id          Int?
  timestamp          DateTime?        @default(now()) @db.Timestamp(6)
  severity           String?          @default("INFO") @db.VarChar(32)
  ip_address         String?          @db.Inet
  user_agent         String?          @db.VarChar(255)
  device_fingerprint String?          @db.VarChar(255)
  tls_version        String?          @db.VarChar(10)
  success_flag       Boolean?         @default(true)
  request_method     String?          @db.VarChar(10)
  request_url        String?
  error_message      String?
  changes            Json?
  old_values         Json?
  affected_records   Int?
  geoip_location     String?          @db.VarChar(255)
  request_headers    Json?
  usersessions       usersessions?    @relation(fields: [session_id], references: [session_id], onUpdate: NoAction)
  users              users?           @relation(fields: [user_id], references: [user_id], onUpdate: NoAction)

  @@index([ip_address], map: "idx_audit_ip_address")
  @@index([operation], map: "idx_audit_operation")
  @@index([severity, timestamp], map: "idx_audit_severity_timestamp")
  @@index([table_name, timestamp], map: "idx_audit_table_timestamp")
  @@index([timestamp, user_id, severity], map: "idx_audit_timestamp_user")
  @@index([user_id], map: "idx_audit_user_id")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model caretakerassignments {
  assignment_id Int       @id @default(autoincrement())
  user_id       Int
  cat_id        Int
  assigned_at   DateTime? @default(now()) @db.Timestamp(6)
  unassigned_at DateTime? @db.Timestamp(6)
  cats          cats      @relation(fields: [cat_id], references: [cat_id], onDelete: Cascade, onUpdate: NoAction)
  users         users     @relation(fields: [user_id], references: [user_id], onDelete: Cascade, onUpdate: NoAction)

  @@index([cat_id, assigned_at], map: "idx_caretaker_cat_assigned")
  @@index([user_id, unassigned_at], map: "idx_caretaker_user_unassigned")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model cats {
  cat_id               Int                    @id @default(autoincrement())
  name                 String                 @db.VarChar(64)
  breed                String?                @db.VarChar(64)
  birth_date           DateTime               @db.Date
  description          String?                @db.VarChar(2048)
  filename             String?                @db.VarChar(255)
  created_at           DateTime?              @default(now()) @db.Timestamp(6)
  updated_at           DateTime?              @default(now()) @db.Timestamp(6)
  caretakerassignments caretakerassignments[]

  @@index([birth_date], map: "idx_cats_birth_date")
  @@index([created_at(sort: Desc)], map: "idx_cats_created_at")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model loginattempts {
  attempt_id   Int       @id @default(autoincrement())
  username     String    @db.VarChar(64)
  ip_address   String    @db.Inet
  success      Boolean?  @default(false)
  reason       String?   @db.VarChar(255)
  attempted_at DateTime? @default(now()) @db.Timestamp(6)

  @@index([ip_address, attempted_at(sort: Desc)], map: "idx_login_ip_time")
  @@index([username, attempted_at(sort: Desc)], map: "idx_login_username_time")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model mfatokens {
  token_id         Int           @id @default(autoincrement())
  user_id          Int
  token_type       mfa_type_enum
  token_value      Bytes
  token_iv         Bytes?
  key_version      Int           @default(1)
  created_at       DateTime?     @default(now()) @db.Timestamp(6)
  last_used_at     DateTime?     @db.Timestamp(6)
  is_active        Boolean?      @default(true)
  revoked_at       DateTime?     @db.Timestamp(6)
  failed_attempts  Int?          @default(0)
  mfa_locked_until DateTime?     @db.Timestamp(6)
  users            users         @relation(fields: [user_id], references: [user_id], onDelete: Cascade, onUpdate: NoAction)

  @@index([is_active, revoked_at], map: "idx_mfa_active_revoked")
  @@index([user_id, is_active], map: "idx_mfa_user_active")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model passwordhistory {
  history_id        Int       @id @default(autoincrement())
  user_id           Int
  old_password_hash String    @db.VarChar(255)
  changed_at        DateTime? @default(now()) @db.Timestamp(6)
  users             users     @relation(fields: [user_id], references: [user_id], onDelete: Cascade, onUpdate: NoAction)

  @@index([user_id, changed_at(sort: Desc)], map: "idx_password_history_user")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model roles {
  role_id     Int       @id @default(autoincrement())
  role_name   String    @unique @db.VarChar(32)
  description String?
  created_at  DateTime? @default(now()) @db.Timestamp(6)
  updated_at  DateTime? @default(now()) @db.Timestamp(6)
  users       users[]
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model trusteddevices {
  device_id             Int       @id @default(autoincrement())
  user_id               Int
  device_fingerprint    Bytes
  device_fingerprint_iv Bytes?
  device_name           String?   @db.VarChar(255)
  ip_address            String?   @db.Inet
  first_seen            DateTime? @default(now()) @db.Timestamp(6)
  last_seen             DateTime? @default(now()) @db.Timestamp(6)
  is_trusted            Boolean?  @default(false)
  revoked_at            DateTime? @db.Timestamp(6)
  trust_expires_at      DateTime? @default(dbgenerated("(now() + '90 days'::interval)")) @db.Timestamp(6)
  users                 users     @relation(fields: [user_id], references: [user_id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([user_id, device_fingerprint], map: "unique_device_per_user")
  @@index([is_trusted, revoked_at, trust_expires_at], map: "idx_trusted_devices_status")
  @@index([user_id, device_fingerprint], map: "idx_trusted_devices_user")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model users {
  user_id                  Int                    @id @default(autoincrement())
  username                 String                 @unique(map: "idx_users_username") @db.VarChar(64)
  email                    String                 @unique(map: "idx_users_email") @db.VarChar(255)
  password_hash            String                 @db.VarChar(255)
  role_id                  Int
  is_active                Boolean?               @default(true)
  last_password_change     DateTime?              @db.Timestamp(6)
  password_expires_at      DateTime?              @db.Timestamp(6)
  account_locked_until     DateTime?              @db.Timestamp(6)
  password_change_required Boolean?               @default(false)
  created_at               DateTime?              @default(now()) @db.Timestamp(6)
  updated_at               DateTime?              @default(now()) @db.Timestamp(6)
  auditlogs                auditlogs[]
  caretakerassignments     caretakerassignments[]
  mfatokens                mfatokens[]
  passwordhistory          passwordhistory[]
  trusteddevices           trusteddevices[]
  roles                    roles                  @relation(fields: [role_id], references: [role_id], onDelete: NoAction, onUpdate: NoAction)
  usersessions             usersessions[]

  @@index([role_id, is_active], map: "idx_users_role_active")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model usersessions {
  session_id              Int         @id @default(autoincrement())
  user_id                 Int
  session_token_hash      String      @unique @db.VarChar(255)
  session_token_iv        Bytes?
  ip_address              String      @db.Inet
  user_agent              String?     @db.VarChar(255)
  device_fingerprint      Bytes?
  tls_version             String?     @db.VarChar(10)
  tls_cipher_suite        String?     @db.VarChar(255)
  certificate_fingerprint String?     @db.VarChar(255)
  created_at              DateTime?   @default(now()) @db.Timestamp(6)
  last_activity           DateTime?   @default(now()) @db.Timestamp(6)
  expires_at              DateTime    @db.Timestamp(6)
  is_active               Boolean?    @default(true)
  auditlogs               auditlogs[]
  users                   users       @relation(fields: [user_id], references: [user_id], onDelete: Cascade, onUpdate: NoAction)

  @@index([is_active, expires_at], map: "idx_sessions_active_expires")
  @@index([session_token_hash], map: "idx_sessions_token_hash")
  @@index([user_id, expires_at], map: "idx_sessions_user_expires")
}

enum audit_table_enum {
  Users
  Roles
  Cats
  CaretakerAssignments
  UserSessions
  LoginAttempts
  PasswordHistory
  TrustedDevices
  MFATokens
}

enum mfa_type_enum {
  TOTP
  U2F
  BACKUP_CODE
}
